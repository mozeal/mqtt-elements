<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="mqtt-publish-regestration-behaviour.html">

<!--
The `mqtt-subscription` element

@demo demo/index.html
-->

<dom-module id="mqtt-publish">
  <template>
  </template>
</dom-module>

<script>

  'use strict';

  Polymer({
    is: 'mqtt-publish',

    /**
     * Fired when a publication is published.
     *
     * @event mqtt-publication-published
     * @param {{
     *   topic:  string,
     *   qos: number,
     *   retained: boolean
     * }}
     */

    properties: {

      /**
       * If auto is set to true `<mqtt-publish auto>` then an MQTT message is send each time
       * the payload is changed.
       */
      auto: {
        type: Boolean,
        value: false
      },

      /**
       * The quality of service the MQTT publication is send to the MQTT broker
       */
      qos: {
        type: Number,
        value: 0
      },

      /**
       * The topic the publication is made to
       */
      topic: {
        type: String,
      },

      /**
       * The payload that is send to the topic
       */
      payload: {
        type: Object,
        value: {}
      },

      /**
       * True if the publication was successful
       */
      published: {
        type: Boolean,
        value: false
      },

      /**
       * Set retained to true if the message should be saved at the MQTT broker an should "stick" on it.
       */
      retained: {
        type: Boolean,
        value: false
      },

    },

    behaviors: [MqttElements.MqttPublishRegestrationBehaviour],

    observers: [
        '_propertiesChanged(topic, payload, qos, retained)'
    ],

    /**
     * A property observer to send messages if `auto` is set to true and values change
     * @param topic
     * @param payload
     * @param qos
     * @param retained
     * @private
     */
    _propertiesChanged: function(topic, payload, qos, retained){
      if (this.auto && topic && payload && this._parentConnection){
        this._parentConnection.publish(topic, payload, qos, retained);
      }
    },

    publish: function(){
      if (this.topic && this.topic.length > 0 && this.payload && this.payload.length > 0 && this._parentConnection){
        this._parentConnection.publish(this.topic, this.payload, this.qos, this.retained);
      }
    },

    _handelPublicationPublished: function() {
      this.fire("mqtt-publication-published");
    },

  });
</script>
