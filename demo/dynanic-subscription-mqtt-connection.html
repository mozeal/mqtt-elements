<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>inject &lt;mqtt-connection&gt; Demo</title>
  <script src="../../webcomponentsjs/webcomponents.js"></script>
  <link rel="import" href="../mqtt-elements.html">
  <link rel="import" href="../../paper-button/paper-button.html">
  <link rel="import" href="../../paper-input/paper-input.html">
</head>

<body>
<template is="dom-bind">
  <h1>Con1: <span>[[connected]]</span></h1>
  <h1>Con2: <span>[[connected2]]</span></h1>

  <mqtt-connection auto id="connection" url="ws://127.0.0.1:3005" connected="{{connected}}" client="{{client}}" on-mqtt-message="_handelMqttMessage">
  </mqtt-connection>

  <mqtt-connection id="con" connected="{{connected2}}" client="{{client}}" on-mqtt-message="_handelMqttMessage">
    <template is="dom-repeat" items="{{subs}}">
      <mqtt-subscription  topic="{{item.topic}}" subscribed="{{item.subscribed}}"></mqtt-subscription>
    </template>
  </mqtt-connection>

  <paper-button raised on-tap="_addSub">Add Sub</paper-button>
  <paper-button raised on-tap="_sendMessage">Send Message</paper-button>
  <paper-input label="topic" value="{{topic}}"></paper-input>
  <paper-input label="message" value="{{message}}"></paper-input>

  <div id="content">
    <h1>Subscriptions:</h1>
    <template is="dom-repeat" items="{{subs}}">
      <div>
        <span>{{item.topic}}</span>
      </div>
      <div>
        <span>{{item.subscribed}}</span>
      </div>
    </template>

    <h1>Messages:</h1>
    <template is="dom-repeat" items="{{messages}}">
      <div>
        <span>{{item.topic}}</span>:<span>{{item.message}}</span>
      </div>

    </template>
  </div>
</template>

<script>

  var demo = document.querySelector('template[is="dom-bind"]');
  var connection = document.querySelector('#connection');

  demo.subs = [{topic: "xyz", subscribed: false}, {topic: "abc", subscribed: false}];
  demo.messages = [];

  demo._sendMessage =  function(event){
    console.log("_sendMessage", event);
    this.client.publish(this.topic, this.message);
  };

  demo._handelMqttMessage = function (event, message) {
    console.log("_handelMqttMessage", event.target.client.options.clientId);
    if(message && message.topic) {
      this.push('messages', {
        topic: message.topic,
        message: String.fromCharCode.apply(null, message.message)
      });
    }
  };

  demo._addSub = function(event){

    console.log("_addSub", event);
    this.push("subs", {topic: demo.topic, subscribed: false});
//    this.subs.push({topic: demo.topic, subscribed: false});
  };

  demo._addSub.bind(demo);
  demo._handelMqttMessage.bind(demo);

</script>
</body>
</html>
