<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>inject &lt;mqtt-connection&gt; Demo</title>
  <script src="../../webcomponentsjs/webcomponents.js"></script>
  <link rel="import" href="../mqtt-elements.html">
  <link rel="import" href="../../paper-button/paper-button.html">
  <link rel="import" href="../../paper-toggle-button/paper-toggle-button.html">
  <link rel="import" href="../../paper-input/paper-input.html">
  <link rel="import" href="../../paper-styles/demo-pages.html">
  <style is="custom-style">
    .line {
      margin-right: 24px;
    }

    .horizontal-section-container-end {
      margin-top: 16px;
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--layout-end-justified);
    }
  </style>
</head>

<body unresolved>
<template is="dom-bind">


  <mqtt-connection
      id="connection"
      url="[[toWsUrl(url, port)]]"
      connected="{{connected}}"
      client="{{client}}"
      subscriptions="{{subscriptions}}"

      on-mqtt-message="_handelMqttMessage">

    <mqtt-subscription topic="[[topicA]]"
                       number-of-messages="Infinity"
                       last-message="{{lastMessageA}}"
                       messages="{{messagesA}}"
                       qos="1"
                       subscribed="{{subA}}"></mqtt-subscription>

    <mqtt-publish id="pub" topic="[[topicA]]"
                  payload="[[value]]"
                  auto$="[[pubAuto]]"
                  retained="[[pubRetained]]"></mqtt-publish>
  </mqtt-connection>


  <div class="layout wrap center-center">
    <div class="vertical-section">
      <h1>&lt;mqtt-connection&gt;</h1>
      <paper-input label="MQTT-Broker URL" value="{{url}}"></paper-input>
      <paper-input label="MQTT-Broker Port" value="{{port}}"></paper-input>

      <paper-button on-tap="connect">connect</paper-button>
      <paper-button on-tap="disconnect">disconnect</paper-button>
    </div>

    <div class="vertical-section">
      <h3>Connection Status <span>[[connected]]</span></h3>
      <paper-button on-tap="_sendMessage2">Send Message2</paper-button>
    </div>

    <div class="vertical-section">
      <h3>Publish on <span>[[topicA]]</span></h3>
      <paper-input label="topic" value="{{topicA}}"></paper-input>
      <paper-input label="Payload" char-counter value="{{value}}"></paper-input>
      <div class="horizontal-section-container-end">
        <div class="line">
          <paper-toggle-button checked="{{pubAuto}}"></paper-toggle-button>
          <span>Auto</span>
        </div>
        <div class="line">
          <paper-toggle-button checked="{{pubRetained}}"></paper-toggle-button>
          <span>Retain</span>
        </div>
        <paper-button raised on-tap="_sendMessage">Send Message</paper-button>
      </div>
    </div>

    <div class="vertical-section">
      <template is="dom-repeat" items="{{subscriptions}}">
        <div>
          Topic: <span>{{item.topic}}</span>
          <!--Qos: <span>{{item.qos}}</span>-->
        </div>
      </template>
    </div>


    <div class="vertical-section">
      <div class="">
        <h3>Messages on <span>[[topicA]]</span></h3>
        <div>subscribed <span>[[subA]]</span></div>
      </div>
      <div>
        lastMessage: <span>[[lastMessageA.parsedPayload]]</span>
      </div>
      <div>
        <template is="dom-repeat" items="{{messagesA}}">
          <div>
            Topic: <span>{{item.topic}}</span>
            Payload: <span>{{item.parsedPayload}}</span>
            Qos: <span>{{item.message.qos}}</span>
            dup: <span>{{item.message.dup}}</span>
            retain: <span>{{item.message.retain}}</span>
          </div>
        </template>
      </div>
    </div>

  </div>


  <div>
    <h1>messagesA</h1>

    <template is="dom-repeat" items="{{messagesA}}">
      <div>
        Topic: <span>{{item.topic}}</span>
        Payload: <span>{{item.parsedPayload}}</span>
        Qos: <span>{{item.message.qos}}</span>
        dup: <span>{{item.message.dup}}</span>
        retain: <span>{{item.message.retain}}</span>
      </div>
    </template>
  </div>

  <div>
    <h1>messagesB</h1>

    <template is="dom-repeat" items="{{messagesB}}">
      <div>
        Topic: <span>{{item.topic}}</span>
        Payload: <span>{{item.parsedPayload}}</span>
        Qos: <span>{{item.message.qos}}</span>
        dup: <span>{{item.message.dup}}</span>
        retain: <span>{{item.message.retain}}</span>
      </div>
    </template>
  </div>

  <div id="content">
    <h1>
      All Messages
    </h1>
    <template is="dom-repeat" items="{{messages}}">
      <div>
        <span>{{item.topic}}</span>
        <span>{{item.message}}</span>
      </div>
    </template>
  </div>
</template>


<script>
  var demo = document.querySelector('template[is="dom-bind"]');
  var content = document.querySelector('#content');

  demo.messages = [];

  demo._sendMessage = function (event) {
    this.$.pub.publish();
  };


  demo._handelMqttMessage = function (event, message) {
    if(message && message.topic) {
      this.push('messages', {
        topic: message.topic,
        message: String.fromCharCode.apply(null, message.message)
      });
    }
  };


  demo.parseMessage = function (message) {
    return String.fromCharCode.apply(null, message.message.payload);
  };

  demo.toWsUrl = function(url,port){
    return "ws://" + url + ":" + port;
  };

  demo.disconnect = function () {
    this.$.connection.disconnect();
  };

  demo.connect = function () {
    this.$.connection.connect();
  };

  demo.url = "127.0.0.1";
  demo.port = 3005;
  demo.topic = "foo/bar";
  demo.topicA = "foo/bar";
  demo.topicB = "xyz/abc";



</script>

<script src="../dist/setImmediate.js"></script>
</body>
</html>
